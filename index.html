<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Threat Intelligence Platform</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding-top: 20px;
    }
    section { margin-bottom: 40px; }
    #statsResult, #chatOutput, #newsList { margin-top: 10px; }
    #chatOutput { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; min-height: 50px; }
    #newsList { text-align: left; display: inline-block; max-width: 600px; }
    #newsList li { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>Threat Intelligence Platform</h1>
  <section id="stats">
    <h2>Israel Attack Stats</h2>
    <button id="fetchStats">Refresh</button>
    <div id="statsResult">Click Refresh to fetch data.</div>
  </section>
  <section id="news">
    <h2>Latest Threat News</h2>
    <button id="loadNews">Load News</button>
    <ul id="newsList"></ul>
  </section>
  <section id="chat">
    <h2>AI Chatbot</h2>
    <p>
      OpenAI API Key:
      <input type="password" id="apiKey" placeholder="sk-..." style="width:200px;"/>
    </p>
    <textarea id="chatInput" rows="3" style="width:100%;max-width:600px;"></textarea><br>
    <button id="sendChat">Send</button>
    <div id="chatOutput"></div>
  </section>
  <script>
    const statsResult = document.getElementById('statsResult');
    const newsList = document.getElementById('newsList');
    const apiKeyInput = document.getElementById('apiKey');
    const chatInput = document.getElementById('chatInput');
    const chatOutput = document.getElementById('chatOutput');

    apiKeyInput.value = localStorage.getItem('OPENAI_KEY') || '';
    apiKeyInput.addEventListener('input', () => {
      localStorage.setItem('OPENAI_KEY', apiKeyInput.value);
    });

    let latestReportsSummary = '';

    async function fetchStats() {
      statsResult.textContent = 'Fetching...';
      try {
        const resp = await fetch('https://isc.sans.edu/api/country?json');
        const data = await resp.json();
        const il = data.find(e => e.country === 'IL');
        if (!il) {
          statsResult.textContent = 'No data for IL';
          return;
        }
        const flag = '\u{1F1EE}\u{1F1F1}'; // ðŸ‡®ðŸ‡±
        statsResult.textContent = `${flag} ${il.targets} targets from ${il.sources} sources`;
      } catch (err) {
        statsResult.textContent = 'Error: ' + err.message;
      }
    }

    async function loadNews() {
      newsList.innerHTML = 'Loading...';
      try {
        const resp = await fetch('https://api.allorigins.win/raw?url=https://isc.sans.edu/rssfeed.xml');
        const text = await resp.text();
        const doc = new DOMParser().parseFromString(text, 'application/xml');
        const items = Array.from(doc.querySelectorAll('item')).slice(0,5);
        newsList.innerHTML = '';
        latestReportsSummary = '';
        items.forEach(item => {
          const title = item.querySelector('title')?.textContent || '';
          const link = item.querySelector('link')?.textContent || '';
          const desc = item.querySelector('description')?.textContent || '';
          const li = document.createElement('li');
          li.innerHTML = `<a href="${link}" target="_blank">${title}</a><p>${desc}</p>`;
          newsList.appendChild(li);
          latestReportsSummary += `${title} - ${desc}\n`;
        });
      } catch (err) {
        newsList.textContent = 'Error loading news: ' + err.message;
      }
    }

    async function sendChat() {
      const apiKey = apiKeyInput.value.trim();
      if (!apiKey) {
        alert('Please enter your OpenAI API key.');
        return;
      }
      const userMsg = chatInput.value.trim();
      if (!userMsg) return;
      chatOutput.textContent = 'Thinking...';
      try {
        const body = {
          model: 'gpt-3.5-turbo',
          messages: [
            { role: 'system', content: 'You are a cybersecurity assistant focused on Israel. Here are recent reports:\n' + latestReportsSummary },
            { role: 'user', content: userMsg }
          ]
        };
        const resp = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + apiKey
          },
          body: JSON.stringify(body)
        });
        const data = await resp.json();
        const msg = data.choices?.[0]?.message?.content || 'No response';
        chatOutput.textContent = msg;
      } catch (err) {
        chatOutput.textContent = 'Error: ' + err.message;
      }
    }

    document.getElementById('fetchStats').addEventListener('click', fetchStats);
    document.getElementById('loadNews').addEventListener('click', loadNews);
    document.getElementById('sendChat').addEventListener('click', sendChat);
  </script>
</body>
</html>
